import os
import re
import glob
import matplotlib.pyplot as plt
import matplotlib.font_manager as font_manager
import numpy as np

font_path = './gillsans.ttf'
font_prop = font_manager.FontProperties(fname=font_path, size=18)
colors = ['#D55E00', '#0072B2', '#009E73', '#000000', '#800080', '#CC79A7', '#E69F00', '#56B4E9']
markers = ['o', 's', 'd', '^']
apps_dict = {
    'AMG2023': 0,
    'MILC': 1,
    'deepCAM': 2,
    'nanoGPT': 3
}

# x_vals = [4, 6, 5, 4, 2, 3, 3, 2, 1, 2, 1, 3, 2, 5, 4, 2, 3, 2, 2, 2, 4, 4, 2, 3, 3, 2, 3, 1, 3, 2, 6, 4, 1, 2, 0, 1, 3, 2, 5, 2, 1, 2, 2, 0, 2, 4, 1, 4, 3, 5, 1, 3, 1, 0, 3, 4, 5, 2, 3, 4, 2, 0, 2, 1, 7, 5, 3, 5, 4, 5, 3, 4, 3, 3, 3, 3, 5, 6, 5, 1, 6, 1, 7, 2, 5, 3, 1, 3, 6, 1, 2, 3, 1, 2, 4, 1, 5, 3, 0, 2, 4, 1, 2, 1, 2, 0, 5, 1, 2, 3, 4, 6, 4, 3, 2, 2, 3, 4, 2, 3, 3, 2, 5, 0]
# y_vals = [267.89935, 267.20660000000004, 305.25325000000004, 277.82584, 269.91821, 277.67884000000004, 271.3272999999999, 276.01910000000004, 270.80523, 274.09787, 281.72954999999996, 269.53861, 277.87915999999996, 268.2242, 281.7237, 269.96040999999997, 276.91191, 268.00678000000005, 277.71180000000004, 278.9607899999999, 288.06521000000004, 278.07746999999995, 268.74118, 282.01726999999994, 279.27177, 268.51782000000003, 278.55181, 276.78535999999997, 277.78692, 270.9320000000001, 278.62697, 282.00543, 274.96274, 315.23777999999993, 267.34400000000005, 267.48587, 275.22048, 276.51277000000005, 272.25039000000004, 267.62281, 267.13847999999996, 277.11379999999997, 277.23839000000004, 277.7246499999999, 339.20984, 313.50855000000007, 281.0762199999999, 365.5164699999999, 275.12374, 281.1587799999999, 268.95180999999997, 309.0805500000002, 276.99818, 276.85927000000004, 267.87953000000005, 278.60828, 267.79837000000003, 277.61343, 281.27117, 277.18848, 312.55001, 279.10085, 268.7537299999999, 268.42190000000005, 277.73260999999997, 276.2956700000001, 311.38606, 271.7945, 281.8213799999999, 283.16381, 268.84241000000003, 315.46349999999995, 268.53619, 275.88648, 277.4891700000001, 267.88359, 274.17940000000004, 269.67927000000003, 310.91860999999994, 275.38795000000005, 277.70417999999995, 268.52004999999997, 278.77607, 268.17388, 267.69662, 280.09772, 267.73893999999996, 269.53022000000004, 316.56845999999985, 277.53060999999997, 279.49533999999994, 291.2709699999999, 267.1496199999999, 267.35471, 267.60898, 340.94229, 315.79449, 277.85997999999995, 267.64968999999996, 313.35811000000007, 311.42174000000006, 276.37537, 270.05192000000005, 277.79149, 277.0944, 267.76698, 268.64763999999997, 274.7956100000001, 267.27146999999997, 271.35388, 316.62571999999994, 271.19619000000006, 277.95130000000006, 311.55543999999986, 285.9541, 278.08594999999997, 278.99186000000003, 267.61004, 268.47346000000005, 343.51277999999996, 270.46108000000004, 279.023, 267.67866000000004, 270.14838000000003]

# MILC
x_vals = [5, 2, 4, 5, 4, 3, 0, 2, 3, 2, 5, 2, 2, 5, 1, 2, 4, 2, 0, 1, 1, 3, 4, 1, 4, 1, 2, 4, 7, 1, 3, 2, 3, 0, 3, 3, 6, 1, 1, 6, 4, 3, 0, 2, 1, 3, 4, 3, 4, 2, 3, 4, 6, 2, 3, 3, 3, 5, 3, 5, 0, 1, 3, 3, 2, 2, 0, 4, 3, 0, 2, 3, 0, 5, 2, 6, 0, 7]
y_vals = [232.7486, 214.5983, 217.6459, 217.7294, 234.8293, 222.7938, 214.9497, 208.3649, 219.9748, 241.7888, 222.4792, 241.2459, 232.2344, 222.4127, 227.6027, 222.885, 232.2657, 218.3623, 214.6971, 214.2498, 216.1999, 210.7927, 216.5712, 234.2068, 220.3915, 221.4322, 237.6835, 226.8063, 229.2304, 212.4617, 221.3643, 220.4509, 231.7396, 225.0431, 220.0817, 208.4698, 220.3932, 223.3134, 213.0719, 215.0778, 211.2004, 220.4672, 237.6371, 214.4394, 234.51, 213.5008, 225.2432, 217.2899, 225.7682, 213.9867, 224.1334, 263.0813, 213.3706, 225.0883, 226.0256, 238.9853, 226.5071, 216.171, 212.792, 213.8315, 202.5118, 220.4502, 218.8712, 220.7244, 210.2697, 223.2524, 219.3841, 255.5231, 215.8925, 237.6713, 216.2339, 229.0545, 217.8086, 233.3798, 219.8716, 217.4444, 208.263, 214.9355]

min_y = min(y_vals)
y_vals = np.array(y_vals)

plt.figure(figsize=(6,4))
plt.scatter(x_vals, y_vals / min_y, alpha=1, color=colors[apps_dict['MILC']], marker=markers[apps_dict['MILC']], s=80, facecolors='none', edgecolors=colors[apps_dict['MILC']], linewidth=2)
plt.xlabel("Number of slow GPUs", fontproperties=font_prop, fontsize=20)
plt.ylabel("Relative Performance", fontproperties=font_prop, fontsize=20)
plt.title(f"Slow GPU count vs. MILC perf. (Perlmutter)", fontproperties=font_prop, fontsize=21)
plt.grid(True, axis='y', linestyle='--')  # Changed to horizontal dashed grid lines only
plt.xticks(fontproperties=font_prop, fontsize=18)
plt.yticks([1, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35], fontproperties=font_prop, fontsize=18)
plt.tight_layout()
# plt.savefig("slow_gpu_vs_nanogpt_runtime_1_pm.png", dpi=150)
plt.savefig("slow_gpu_vs_milc_runtime_1_pm.pdf")
# plt.show()


# nanoGPT
# x_vals = [0, 3, 6, 0, 6, 0, 0, 3, 0, 6, 6, 3, 0, 6, 4, 1, 3, 1, 3, 3, 0, 3, 5, 0, 4, 9, 1, 1, 1, 1, 1, 4, 5, 4, 2, 7, 0, 1, 0, 2, 3, 1, 3, 3, 2, 8, 0, 2, 1, 3, 3, 9, 4, 4, 3, 1, 3, 8, 9, 1, 0, 2, 2, 1, 4, 3, 2, 1, 2, 1, 0, 0, 2, 0, 1, 1, 9, 5, 1, 6, 1, 8, 1, 10, 1, 0, 0, 2, 0, 2, 3, 5, 5, 3, 8, 3, 4, 5, 1, 8, 2, 2, 3, 0, 0, 1, 5, 2, 12, 3, 2, 6, 0, 3, 0, 7, 4]
# y_vals = [766.56634, 764.00654, 767.05308, 776.2582399999999, 772.78297, 769.11716, 779.73401, 767.5061599999999, 775.6949899999998, 777.8164600000001, 765.1050700000002, 771.22587, 775.40934, 769.0854, 772.40177, 780.3714299999999, 772.4287899999999, 762.01557, 776.2559100000001, 771.1840100000002, 767.8557599999999, 786.0426500000001, 775.2194400000001, 772.7259000000001, 777.5981899999999, 776.7500600000003, 781.98775, 771.7159699999999, 783.7348499999999, 777.6246500000001, 766.88847, 767.8081200000001, 771.9586599999998, 774.2557699999999, 772.2837599999999, 773.1155600000001, 770.0319, 774.6439199999998, 772.8752299999999, 772.7210699999999, 779.3643800000002, 777.5163499999999, 769.0104199999998, 775.7543, 803.4364899999999, 771.00454, 779.2740500000002, 768.3755100000002, 769.1785399999999, 761.5058700000001, 793.3585800000001, 763.6874100000001, 776.8791300000003, 771.8020300000002, 766.1461499999999, 772.3220999999999, 767.14775, 768.1308100000001, 769.7844200000001, 770.6761600000001, 773.6842999999999, 771.83608, 775.5162400000002, 768.5777800000001, 764.0505899999999, 772.8830899999998, 781.5438100000001, 766.81183, 775.9714600000001, 766.82117, 771.14932, 769.9260899999998, 776.39856, 796.02999, 765.16065, 774.8874900000002, 783.06044, 771.7276900000003, 768.29521, 770.2809199999999, 772.4157100000002, 782.2516400000001, 779.8876399999999, 777.5117100000001, 772.46428, 772.8135000000002, 774.799, 768.1679200000002, 771.2528000000001, 764.8441199999999, 770.4463800000002, 780.5927100000004, 780.58829, 772.4074700000001, 764.42828, 766.5665, 774.4998999999998, 769.8330400000002, 785.8081500000002, 763.8456799999999, 772.9407000000001, 769.45571, 771.57725, 770.42125, 768.3451799999999, 779.4316100000002, 776.8177800000002, 773.7799800000001, 769.0196299999999, 771.5472900000002, 774.97976, 772.7083399999997, 779.2082500000001, 775.21965, 769.00296, 768.87871, 763.46086]
# MILC
x_vals = [7, 7, 2, 5, 3, 5, 2, 9, 9, 4, 6, 6, 0, 3, 6, 4, 10, 1, 1, 6, 5, 4, 3, 2, 4, 4, 4, 5, 3, 1, 16, 2, 4, 3, 4, 8, 7, 2]
y_vals = [457.4197, 477.0155, 478.532, 445.587, 378.107, 321.563, 316.8288, 298.6196, 443.4946, 381.4893, 366.9643, 380.9634, 382.2627, 379.177, 382.3915, 424.409, 511.0266, 449.6369, 318.2448, 449.3699, 380.3204, 374.8269, 370.2397, 313.1841, 450.7646, 316.3376, 373.5099, 368.5095, 307.1665, 394.29, 375.1458, 469.8368, 293.4118, 500.8288, 378.5142, 381.6747, 388.9472, 443.7904]

min_y = min(y_vals)
y_vals = np.array(y_vals)

plt.figure(figsize=(6,4))
plt.scatter(x_vals, y_vals / min_y, alpha=1, color=colors[apps_dict['MILC']], marker=markers[apps_dict['MILC']], s=80, facecolors='none', edgecolors=colors[apps_dict['MILC']], linewidth=2)
plt.xlabel("Number of slow GPUs", fontproperties=font_prop, fontsize=20)
plt.ylabel("Relative Performance", fontproperties=font_prop, fontsize=20)
plt.title(f"Slow GPU count vs. MILC perf. (Frontier)", fontproperties=font_prop, fontsize=21)
plt.grid(True, axis='y', linestyle='--')  # Changed to horizontal dashed grid lines only
plt.xticks(fontproperties=font_prop, fontsize=18)
plt.yticks([1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8], fontproperties=font_prop, fontsize=18)
plt.tight_layout()
# plt.savefig("slow_gpu_vs_nanogpt_runtime_1_frontier.png", dpi=150)
plt.savefig("slow_gpu_vs_milc_runtime_1_frontier.pdf")